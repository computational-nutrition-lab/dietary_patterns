dim(metadata_a)
head(metadata_a)
table(metadata_a$n_diets)  # OK
table(metadata_a$count_na) # OK
# Find the diet they are on.
# Calc rowSums for the diet columns. (because only the columns of the diet that each individual is on has a number, not NA.)
metadata_a$dietcode <- rowSums(metadata_a[, dietsvec], na.rm = T)
# Check
head(metadata_a[, c("SEQN", dietsvec, "dietcode")], 3)
# freq table of diets followed by them.
onedietfreq <- as.data.frame(table(metadata_a$dietcode))
colnames(onedietfreq)[1] <- "dietcode"
onedietfreq
# Append the dietname to the frequency table as well.
onedietfreq_name <- merge(x=onedietfreq, y=diettable, by="dietcode", all.x=T)
sum(onedietfreq_name$Freq) # Should total to the number of individuals following one diet.
onedietfreq_name
# Add the dietname to metadata.
metadata_1diet <- merge(x=metadata_a, y=diettable, by="dietcode", all.x=T)
head(metadata_1diet,1)
# metadata_1diet has the metadata of the individuals who are in QCtotal and following one specific diet.
# Extract only necessary info.
metadata_b <- metadata_1diet[, c("SEQN", "dietcode", "dietname")]
head(metadata_b)
# Take the first 20 individuals from weight-loss (low calorie; n=300), diabetic (n=97),
# low-salt (n=51), low-fat (n=43), and low-carb (n=33)
weightloss <- subset(metadata_1diet, dietname == "Weight_loss")[1:20, "SEQN"]
diabetic <- subset(metadata_1diet, dietname   == "Diabetic")[1:20, "SEQN"]
lowsalt <- subset(metadata_1diet, dietname    == "Low_salt")[1:20, "SEQN"]
lowfat <- subset(metadata_1diet, dietname     == "Low_fat")[1:20, "SEQN"]
lowcarb <- subset(metadata_1diet, dietname    == "Low_carb")[1:20, "SEQN"]
regulardiet <- subset(metadata, DRQSDIET == 2)[1:20, "SEQN"] # those are not following any specific diet.
# Combine those
diffdiet120_short <- data.frame(Weight_loss=weightloss,
Diabetic=diabetic,
Low_salt=lowsalt,
Low_fat=lowfat,
Low_carb=lowcarb,
Regular=regulardiet)
diffdiet120_short
# Create a long table out of this.
library(reshape2)
diffdiet120 <- melt(diffdiet120_short)
colnames(diffdiet120) <- c("Diet", "SEQN")
head(diffdiet120)
# ---------------------------------------------------------------------------------------------------
# Add diet info while picking up the individuals from totalQC.
QCtotal_1diet <- merge(x=diffdiet120, y=QCtotal, by="SEQN", all.x=T)
head(QCtotal_1diet, 2)
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=KCAL)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=TFAT)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=PROT)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=CARB)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=FIBE)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=PF_TOTAL)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=V_TOTAL)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=V_STARCHY_OTHER)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=V_LEGUMES)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=D_TOTAL)) + geom_boxplot()
# ---------------------------------------------------------------------------------------------------
# Define the sample total data with which you are going to do clustering.
totals_QCed_sampled <- QCtotal_1diet
# Plot PC1 and PC2 and color-code individuals by their diet.
# Load the FC results
PCA_FC <- read.table("results/PCA_results/NHANES1516_totalsbyhand_FC_n120/NHANES1516_total_d12_FC_mean_QC_2_120diffdiet_input_PCs.txt",
sep="\t", header=T)
head(PCA_FC)
# Plot PC1 and PC2 of the PCA results of Foof Categories.
fillcolor = c("darkred", "orange", "darkgreen", "darkblue", "violet", "grey45")
colcolor = c("darkred", "orange", "darkgreen", "darkblue", "violet", "grey45")
ggplot(data=PCA_FC, aes(x=PC1, y=PC2, fill=Diet, color=Diet, shape=Diet))+
geom_point(size=3) +
scale_fill_manual(values=fillcolor) +
scale_color_manual(values=colcolor) +
theme(legend.position = "bottom")
diffdiet120_short
# Take the first 20 individuals from High_prot (n=6), GF (n=4), Low_salt (n=51), weight_gain (n=12),
# Low-carb (n=33).
highprot <- subset(metadata_1diet, dietname   == "High_prot")[1:6, "SEQN"]
GF <-      subset(metadata_1diet, dietname    == "GF")[1:4, "SEQN"]
lowsalt <- subset(metadata_1diet, dietname    == "Low_salt")[1:20, "SEQN"]
wtgain <-  subset(metadata_1diet, dietname    == "Weight_gain")[1:12, "SEQN"]
lowcarb <- subset(metadata_1diet, dietname    == "Low_carb")[1:20, "SEQN"]
regulardiet <- subset(metadata, DRQSDIET == 2)[1:20, "SEQN"] # those are not following any specific diet.
10+10+12+20+20
# Combine those
diffdiet72_short <- data.frame(Highprot=highprot,
Gluten_free=GF,
Low_salt=lowsalt,
Weight_gain=wtgain,
Low_carb=lowcarb,
Regular=regulardiet)
head(highprot,2)
rep('Highprot',3)
nrow(highprot)
length(highprot)
diffdiet120_short <- data.frame(Diet = c(rep('Highprot', length(highprot)), rep('Gluten_free', length(GF)),
)
)
rep('Low_carb', length(lowcarb))
rep('Regular', length(regulardiet))
highprot
diffdiet120_short <- data.frame( Diet = c(rep('Highprot', length(highprot)), rep('Gluten_free', length(GF)),
rep('Low_salt', length(lowsalt)), rep('Weight_gain', length(wtgain)),
rep('Low_carb', length(lowcarb)), rep('Regular', length(regulardiet))),
SEQN = c(highprot, GF, lowsalt, wtgain, lowcarb, regulardiet))
diffdiet72_short <- data.frame( Diet = c(rep('Highprot', length(highprot)), rep('Gluten_free', length(GF)),
rep('Low_salt', length(lowsalt)), rep('Weight_gain', length(wtgain)),
rep('Low_carb', length(lowcarb)), rep('Regular', length(regulardiet))),
SEQN = c(highprot, GF, lowsalt, wtgain, lowcarb, regulardiet))
diffdiet72_short
# ---------------------------------------------------------------------------------------------------
# Add diet info while picking up the individuals from totalQC.
QCtotal_1diet <- merge(x=diffdiet72, y=QCtotal, by="SEQN", all.x=T)
# Combine those
diffdiet72 <- data.frame( Diet = c(rep('Highprot', length(highprot)), rep('Gluten_free', length(GF)),
rep('Low_salt', length(lowsalt)), rep('Weight_gain', length(wtgain)),
rep('Low_carb', length(lowcarb)), rep('Regular', length(regulardiet))),
SEQN = c(highprot, GF, lowsalt, wtgain, lowcarb, regulardiet))
# ---------------------------------------------------------------------------------------------------
# Add diet info while picking up the individuals from totalQC.
QCtotal_1diet <- merge(x=diffdiet72, y=QCtotal, by="SEQN", all.x=T)
head(QCtotal_1diet, 2)
# Save it as an input file.
write.table(QCtotal_1diet, "eg_data/NHANES/NHANES1516_total_d12_FC_mean_QC_2_72diffdiet.txt",
sep="\t", quote=F)
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=KCAL)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=TFAT)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=PROT)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=CARB)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=FIBE)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=PF_TOTAL)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=V_TOTAL)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=V_STARCHY_OTHER)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=V_LEGUMES)) + geom_boxplot()
ggplot(QCtotal_1diet, aes(x=factor(Diet), y=D_TOTAL)) + geom_boxplot()
# ---------------------------------------------------------------------------------------------------
# Define the sample total data with which you are going to do clustering.
totals_QCed_sampled <- QCtotal_1diet
# ---------------------------------------------------------------------------------------------------
# Define the sample total data with which you are going to do clustering.
totals_QCed_sampled <- QCtotal_1diet
# Load the necessary functions
source("lib/prep_data_for_clustering.R")
source("lib/PCA.R")
source("lib/k-means.R")
# ---------------------------------------------------------------------------------------------------
# Define the sample total data with which you are going to do clustering.
totals_QCed_sampled <- QCtotal_1diet
# Some checking... about MOIS and GRMS...
head(totals_QCed_sampled, 2)
head(highprot,2)
head(diffdiet72)
dim(diffdiet72)
rm(diffdiet72)
# ---------------------------------------------------------------------------------------------------
# Add diet info while picking up the individuals from totalQC.
QCtotal_1diet <- merge(x=diffdiet82, y=QCtotal, by="SEQN", all.x=T)
# Combine those
diffdiet82 <- data.frame( Diet = c(rep('Highprot', length(highprot)), rep('Gluten_free', length(GF)),
rep('Low_salt', length(lowsalt)), rep('Weight_gain', length(wtgain)),
rep('Low_carb', length(lowcarb)), rep('Regular', length(regulardiet))),
SEQN = c(highprot, GF, lowsalt, wtgain, lowcarb, regulardiet))
# ---------------------------------------------------------------------------------------------------
# Add diet info while picking up the individuals from totalQC.
QCtotal_1diet <- merge(x=diffdiet82, y=QCtotal, by="SEQN", all.x=T)
head(QCtotal_1diet, 2)
# Save it as an input file.
write.table(QCtotal_1diet, "eg_data/NHANES/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet.txt",
sep="\t", quote=F)
# ---------------------------------------------------------------------------------------------------
# Define the sample total data with which you are going to do clustering.
totals_QCed_sampled <- QCtotal_1diet
# Some checking... about MOIS and GRMS...
head(totals_QCed_sampled, 2)
hist(totals_QCed_sampled$MOIS)
plot(totals_QCed_sampled$MOIS, totals_QCed_sampled$GRMS)
totals_QCed_sampled$GRMSminusMOIS <- totals_QCed_sampled$GRMS - totals_QCed_sampled$MOIS
hist(totals_QCed_sampled$GRMSminusMOIS)
plot(totals_QCed_sampled$GRMS, totals_QCed_sampled$GRMSminusMOIS)
cor.test(totals_QCed_sampled$GRMS, totals_QCed_sampled$GRMSminusMOIS)
colnames(totals_QCed_sampled)
# Define which columns to drop.
drops <- c("KCAL","GRMS", "MOIS", "NoOfItems")
# Take only the columns whose names are NOT in the drop vector.
aaa <- totals_QCed_sampled[ , !(names(totals_QCed_sampled) %in% drops)]
# Save it as totals_QCed_sampled.
totals_QCed_sampled <- aaa
colnames(totals_QCed_sampled)
# Define the input data to be used.
input_data <- totals_QCed_sampled
# The columns specified as start.col, end.col, and all columns in between will be selected.
# Nutrients
SubsetColumns(data=input_data, start.col="PROT", end.col="P226")
# Pick up only the columns with non-zero variance, in order to run PCA, cluster analysis etc.
# The removed columns will be shown if any.
KeepNonZeroVarColumns(data = subsetted)
# Check the columns (variables) remained.
colnames(subsetted_non0var)
dim(subsetted_non0var)
# ---------------------------------------------------------------------------------------------------------------
# Collapse variables by correlation: take only one variables if they are highly correlated.
cbc_res <- CollapseByCorrelation(x = subsetted_non0var,
min.cor = 0.75,
select.rep.fcn = 'mean', verbose = T)
# Filter out highly correlated variables from the original dataset.
selected_variables <- subsetted_non0var[, cbc_res$reps]
# Check to see the name of the original and filtered variables.
# Among the variables in the same group, the one with the highest variance is kept
#  (according to the explanation above.)
# filtered
head(selected_variables, 1)
dim(selected_variables)
# original
head(subsetted_non0var, 1)
dim(subsetted_non0var)
# ---------------------------------------------------------------------------------------------------------------
# Save the variables after removing correlated variables
write.table(selected_variables,
"results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_rv.txt",
sep="\t", row.names=F, quote=F)
# ---------------------------------------------------------------------------------------------------------------
# Save the correlation matrix for record in the results folder.
# cc is the correlation matrix produced when variables are collapsed by correlation.
SaveCorrMatrix(x=cc,
out.fn = "results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_corr_mat.txt")
# Import source code to run the analyses to follow.
# source("lib/specify_dir_and_check_col.R")
# source("lib/prep_data_for_clustering.R")
source("lib/PCA.R")
# Define ggplot themes to use in creating plots.
library(ggplot2)
ggplot2::theme_set(theme_bw(base_size = 14))
# ========================================================================================
# Perform Principal Component Analysis.
# ========================================================================================
#
# ---------------------------------------------------------------------------------------------------------------
# Name your input data.
# Your input data should be a data frame with variables with non-zero variance.
pca_input <- selected_variables
# Ensure your input file has the correct number of rows and columns.
dim(pca_input)
# Perform PCA with the subset data, scaled.
scaled_pca <- prcomp(x=pca_input, scale = TRUE)
# Create a scree plot.
screep <- LineScreePlot(pca.data = pca_input, pca.result = scaled_pca)
screep
colnames(totals_QCed_sampled)
# Define the input data to be used.
input_data <- totals_QCed_sampled
# OR food categories
SubsetColumns(data=input_data, start.col="F_CITMLB", end.col="A_DRINKS")
# Pick up only the columns with non-zero variance, in order to run PCA, cluster analysis etc.
# The removed columns will be shown if any.
KeepNonZeroVarColumns(data = subsetted)
# Check the columns (variables) remained.
colnames(subsetted_non0var)
dim(subsetted_non0var)
# ---------------------------------------------------------------------------------------------------------------
# Collapse variables by correlation: take only one variables if they are highly correlated.
cbc_res <- CollapseByCorrelation(x = subsetted_non0var,
min.cor = 0.75,
select.rep.fcn = 'mean', verbose = T)
# Filter out highly correlated variables from the original dataset.
selected_variables <- subsetted_non0var[, cbc_res$reps]
# Check to see the name of the original and filtered variables.
# Among the variables in the same group, the one with the highest variance is kept
#  (according to the explanation above.)
# filtered
head(selected_variables, 1)
dim(selected_variables)
# original
head(subsetted_non0var, 1)
dim(subsetted_non0var)
# ---------------------------------------------------------------------------------------------------------------
# Save the variables after removing correlated variables
write.table(selected_variables,
"results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_rv.txt",
sep="\t", row.names=F, quote=F)
# ---------------------------------------------------------------------------------------------------------------
# Save the correlation matrix for record in the results folder.
# cc is the correlation matrix produced when variables are collapsed by correlation.
SaveCorrMatrix(x=cc,
out.fn = "results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_corr_mat.txt")
# ========================================================================================
# Perform Principal Component Analysis.
# ========================================================================================
#
# ---------------------------------------------------------------------------------------------------------------
# Name your input data.
# Your input data should be a data frame with variables with non-zero variance.
pca_input <- selected_variables
# Ensure your input file has the correct number of rows and columns.
dim(pca_input)
# Perform PCA with the subset data, scaled.
scaled_pca <- prcomp(x=pca_input, scale = TRUE)
# Create a scree plot.
screep <- LineScreePlot(pca.data = pca_input, pca.result = scaled_pca)
screep
ggsave("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_scree.pdf", screep, device="pdf", width=5, height=5, units="in")
# Create a biplot.
# A biplot with the individuals as black dots and variables labelled.
biplotdots <- BiplotDots(pca.result = scaled_pca, pca.data = pca_input, alpha = 0.5)
biplotdots
ggsave("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_biplotdots.pdf", biplotdots, device="pdf", width=5, height=5, units="in")
# A biplot with the individuals labeled.
biplotlabeled <- BiplotLabeled(pca.result=scaled_pca, pca.data=pca_input, individuals.label = T)
biplotlabeled
ggsave("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_biplotlabeled.pdf", biplotlabeled, device="pdf", width=5, height=5, units="in")
# A biplot with the individuals labeled without the variables' arrows.
biplotlabeledwoarrows <- BiplotLabeledwoArrows(pca.result=scaled_pca, pca.data=pca_input,
individuals.label=T)
ggsave("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_biplotlabeledwoarrows.pdf", biplotlabeledwoarrows, device="pdf", width=5, height=5, units="in")
biplotlabeledwoarrows #+coord_cartesian(xlim=c(-0.1, 0.1), ylim=c(0.05, 0.1))
ggsave("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_biplotlabeledwoarrows.pdf", biplotlabeledwoarrows, device="pdf", width=5, height=5, units="in")
# Plot the directions of the variables.
directions <- BiplotLabeled(pca.result=scaled_pca, pca.data=pca_input, individuals.label=F)
directions
ggsave("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_directions.pdf", directions, device="pdf", width=5, height=5, units="in")
# Plot the contribution of the variables to a given PC: PC1 here.
LoadingsPlot(pca.result=scaled_pca,  whichPC="PC1",
positive.color="green2", negative.color="grey70", sort.variables = T)
loadings_plot
ggsave("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_loadings_PC1.pdf", loadings_plot, device="pdf", width=8, height=4.8, units="in")
# Plot the contribution of the variables to a given PC: PC2 here.
LoadingsPlot(pca.result=scaled_pca,  whichPC="PC2",
positive.color="green2", negative.color="grey70", sort.variables = T)
loadings_plot
ggsave("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_loadings_PC2.pdf", loadings_plot, device="pdf", width=8, height=4.8, units="in")
# ---------------------------------------------------------------------------------------------------------------
# Save the variance explained by each PC as a .txt file.
# Change the file name as necessary.
SaveVarExplained(pca.data = pca_input, pca.result = scaled_pca,
out.fn = "results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_PC_var_explained.txt")
# ---------------------------------------------------------------------------------------------------------------
# Calculate loadings of each PC to the variables and
# save it as a txt file in the results folder.
# Change the file name as necessary.
SaveLoadings(pca.result=scaled_pca,
out.fn="results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_PC_loadings.txt")
# ---------------------------------------------------------------------------------------------------------------
# Save the PC values with the input which has the metadata and food codes, food names.
# Input is your food input file before any prep for clustering, from which you derived the input for the PCA.
SaveInputAndPCs(input = "eg_data/NHANES/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet.txt",
pca.results = scaled_pca,
out.fn = "results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_input_PCs.txt")
GF
# Take the first 20 individuals from High_prot (n=6), GF (n=4), Low_salt (n=51), weight_gain (n=12),
# Low-carb (n=33).
highprot <- subset(metadata_1diet, dietname   == "High_prot")[1:6, "SEQN"]
highprot
View(selected_variables)
# Plot PC1 and PC2 and color-code individuals by their diet.
# Load the FC results
PCA_FC <- read.table("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet_input_PCs.txt",
sep="\t", header=T)
head(PCA_FC)
head(PCA_FC,2)
# Plot PC1 and PC2 of the PCA results of Foof Categories.
fillcolor = c("darkred", "orange", "darkgreen", "darkblue", "violet", "grey45")
colcolor = c("darkred", "orange", "darkgreen", "darkblue", "violet", "grey45")
ggplot(data=PCA_FC, aes(x=PC1, y=PC2, fill=Diet, color=Diet, shape=Diet))+
geom_point(size=3) +
scale_fill_manual(values=fillcolor) +
scale_color_manual(values=colcolor) +
theme(legend.position = "bottom")
ggplot(data=PCA_FC, aes(x=PC1, y=PC2, fill=Diet, color=Diet, shape=Diet))+
geom_point(size=3) +
scale_fill_manual(values=fillcolor) +
scale_color_manual(values=colcolor) +
theme(legend.position = "bottom")+
theme(aspect.ratio = 1)
FCbiplot
FCbiplot <-
ggplot(data=PCA_FC, aes(x=PC1, y=PC2, fill=Diet, color=Diet, shape=Diet))+
geom_point(size=3) +
scale_fill_manual(values=fillcolor) +
scale_color_manual(values=colcolor) +
theme(legend.position = "bottom")+
theme(aspect.ratio = 1)
FCbiplot
ggsave("FCbiplot.tif", device = "tiff", width = 7, height=7, dpi=250)
ggsave("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/FCbiplot.tif", device = "tiff", width = 7, height=7, dpi=250)
ggsave("results/PCA_results/NHANES1516_totalsbyhand_FC_n82/FCbiplot.tif", device = "tiff", width = 7, height=7, dpi=250)
colnames(totals_QCed_sampled)
# Define which columns to drop.
drops <- c("KCAL","GRMS", "MOIS", "NoOfItems")
# Take only the columns whose names are NOT in the drop vector.
aaa <- totals_QCed_sampled[ , !(names(totals_QCed_sampled) %in% drops)]
# Save it as totals_QCed_sampled.
totals_QCed_sampled <- aaa
colnames(totals_QCed_sampled)
# Define the input data to be used.
input_data <- totals_QCed_sampled
# The columns specified as start.col, end.col, and all columns in between will be selected.
# Nutrients
SubsetColumns(data=input_data, start.col="PROT", end.col="P226")
# Pick up only the columns with non-zero variance, in order to run PCA, cluster analysis etc.
# The removed columns will be shown if any.
KeepNonZeroVarColumns(data = subsetted)
# Check the columns (variables) remained.
colnames(subsetted_non0var)
dim(subsetted_non0var)
# ---------------------------------------------------------------------------------------------------------------
# Collapse variables by correlation: take only one variables if they are highly correlated.
cbc_res <- CollapseByCorrelation(x = subsetted_non0var,
min.cor = 0.75,
select.rep.fcn = 'mean', verbose = T)
# Filter out highly correlated variables from the original dataset.
selected_variables <- subsetted_non0var[, cbc_res$reps]
# Filter out highly correlated variables from the original dataset.
selected_variables <- subsetted_non0var[, cbc_res$reps]
# Check to see the name of the original and filtered variables.
# Among the variables in the same group, the one with the highest variance is kept
#  (according to the explanation above.)
# filtered
head(selected_variables, 1)
dim(selected_variables)
# ========================================================================================
# Perform Principal Component Analysis.
# ========================================================================================
#
# ---------------------------------------------------------------------------------------------------------------
# Name your input data.
# Your input data should be a data frame with variables with non-zero variance.
pca_input <- selected_variables
# Ensure your input file has the correct number of rows and columns.
dim(pca_input)
# Perform PCA with the subset data, scaled.
scaled_pca <- prcomp(x=pca_input, scale = TRUE)
# Create a scree plot.
screep <- LineScreePlot(pca.data = pca_input, pca.result = scaled_pca)
screep
ggsave("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_scree.pdf", screep, device="pdf", width=5, height=5, units="in")
# Create a biplot.
# A biplot with the individuals as black dots and variables labelled.
biplotdots <- BiplotDots(pca.result = scaled_pca, pca.data = pca_input, alpha = 0.5)
biplotdots
ggsave("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_biplotdots.pdf", biplotdots, device="pdf", width=5, height=5, units="in")
# A biplot with the individuals labeled.
biplotlabeled <- BiplotLabeled(pca.result=scaled_pca, pca.data=pca_input, individuals.label = T)
biplotlabeled
ggsave("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_biplotlabeled.pdf", biplotlabeled, device="pdf", width=5, height=5, units="in")
# A biplot with the individuals labeled without the variables' arrows.
biplotlabeledwoarrows <- BiplotLabeledwoArrows(pca.result=scaled_pca, pca.data=pca_input,
individuals.label=T)
biplotlabeledwoarrows #+coord_cartesian(xlim=c(-0.1, 0.1), ylim=c(0.05, 0.1))
ggsave("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_biplotlabeledwoarrows.pdf", biplotlabeledwoarrows, device="pdf", width=5, height=5, units="in")
# Plot the directions of the variables.
directions <- BiplotLabeled(pca.result=scaled_pca, pca.data=pca_input, individuals.label=F)
directions
ggsave("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_directions.pdf", directions, device="pdf", width=5, height=5, units="in")
# Plot the contribution of the variables to a given PC: PC1 here.
LoadingsPlot(pca.result=scaled_pca,  whichPC="PC1",
positive.color="green2", negative.color="grey70", sort.variables = T)
loadings_plot
ggsave("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_loadings_PC1.pdf", loadings_plot, device="pdf", width=8, height=4.8, units="in")
# Plot the contribution of the variables to a given PC: PC2 here.
LoadingsPlot(pca.result=scaled_pca,  whichPC="PC2",
positive.color="green2", negative.color="grey70", sort.variables = T)
loadings_plot
ggsave("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_loadings_PC2.pdf", loadings_plot, device="pdf", width=8, height=4.8, units="in")
# ---------------------------------------------------------------------------------------------------------------
# Save the variance explained by each PC as a .txt file.
# Change the file name as necessary.
SaveVarExplained(pca.data = pca_input, pca.result = scaled_pca,
out.fn = "results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_PC_var_explained.txt")
# ---------------------------------------------------------------------------------------------------------------
# Calculate loadings of each PC to the variables and
# save it as a txt file in the results folder.
# Change the file name as necessary.
SaveLoadings(pca.result=scaled_pca,
out.fn="results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_PC_loadings.txt")
# ---------------------------------------------------------------------------------------------------------------
# Save the PC values with the input which has the metadata and food codes, food names.
# Input is your food input file before any prep for clustering, from which you derived the input for the PCA.
SaveInputAndPCs(input = "eg_data/NHANES/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet.txt",
pca.results = scaled_pca,
out.fn = "results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_input_PCs.txt")
# ---------------------------------------------------------------------------------------------------------------
# Save the PC values with the input which has the metadata and food codes, food names.
# Input is your food input file before any prep for clustering, from which you derived the input for the PCA.
SaveInputAndPCs(input = "eg_data/NHANES/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet.txt",
pca.results = scaled_pca,
out.fn = "results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_input_PCs.txt")
# ---------------------------------------------------------------------------------------------------------------
# Save the PC values with the input which has the metadata and food codes, food names.
# Input is your food input file before any prep for clustering, from which you derived the input for the PCA.
SaveInputAndPCs(input = "eg_data/NHANES/NHANES1516_total_d12_FC_mean_QC_2_82diffdiet.txt",
pca.results = scaled_pca,
out.fn = "results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_input_PCs.txt")
# Load the nutrient results
PCA_nut <- read.table("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/NHANES1516_total_d12_nut_mean_QC_2_82diffdiet_input_PCs.txt",
sep="\t", header=T)
head(PCA_nut)
nutbiplot <-
ggplot(data=PCA_nut, aes(x=PC1, y=PC2, fill=Diet, color=Diet, shape=Diet))+
geom_point(size=3) +
scale_fill_manual(values=fillcolor) +
scale_color_manual(values=colcolor) +
theme(legend.position = "bottom")
nutbiplot
nutbiplot <-
ggplot(data=PCA_nut, aes(x=PC1, y=PC2, fill=Diet, color=Diet, shape=Diet))+
geom_point(size=3) +
scale_fill_manual(values=fillcolor) +
scale_color_manual(values=colcolor) +
theme(legend.position = "bottom") +
theme(aspect.ratio = 1)
nutbiplot
ggsave("results/PCA_results/NHANES1516_totalsbyhand_nut_n82/nutbiplot.tif", nutbiplot, device = "tiff", width = 7, height=7, dpi=250)
